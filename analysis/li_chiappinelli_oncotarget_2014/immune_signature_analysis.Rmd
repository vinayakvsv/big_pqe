---
title: "Li and Chiappinelli Immune signature analysis"
output: html_notebook
---

# Setup packages
```{r setup}
# source("https://bioconductor.org/biocLite.R")
biocLite("Biobase")
biocLite("GEOquery")
biocLite("limma")
```



# Import the data

```{r sig1}
# Version info: R 3.2.3, Biobase 2.30.0, GEOquery 2.40.0, limma 3.26.8
# R scripts generated  Thu Aug 30 14:01:47 EDT 2018

################################################################
#   Differential expression analysis with limma
library(Biobase)
library(GEOquery)
# source("GEOpatch.R")
library(limma)
```

```{r downloadgeo}
# load series and platform data from GEO

gset0 <- getGEO("GSE57341",destdir = getwd())
if (length(gset0) > 1) {
  idx <- grep("GPL4133", attr(gset, "names")) 
} else {
  idx <- 1
}

gset <- gset0[[idx]]

# make proper column names to match toptable 
fvarLabels(gset) <- make.names(fvarLabels(gset))

```

Is there some way we can import the metadata used for this study?

Yes

```{r set_design}
gset_meta <- data.frame(cell_line = gset$`cell line:ch1`,
                        cell_type = gset$`cell type:ch2`,
                        time = gset$`time point:ch1`,
                        source_ch1 = gset$source_name_ch1,
                        source_ch2 = gset$source_name_ch2)
rownames(gset_meta) <- gset$geo_accession
```

# Set a comparison

Note that every sample consists of two channels: one corresponding to the control (untreated) and one corresponding to the AZA. So, every sample will have a set of genes that differ in the treatment versus a control. For each gene, the colors for one of the two channel indicates whether the gene has a raised expression level in the treatment or control. We want to examine whether the genes that differ for one set of channels corresponding to a condition are different as the genesthat differ for another set of channels corresponding to a different condition.

We will compare the following: 
1. Each of the timepoints -- we want those that remain high even 14 days after induction
2. Each type of tissue
3. Each cell line--we want to get the genes that differ the least and are elevated in Aza

```{r set_by_cell_line}

is_breast <- which(grepl(pattern = "breast",x = gset_meta$cell_type))
is_ovarian <- which(grepl(pattern = "ovarian",x = gset_meta$cell_type))
is_colon <- which(grepl(pattern = "colon",x = gset_meta$cell_type))

```




```{r define_conditions}

# group names for all samples
gsms <- paste0("XXXX0000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
        "XXXXXXXXXXX1111XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
        "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
        "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
        "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX")
sml <- c()
for (i in 1:nchar(gsms)) { sml[i] <- substr(gsms,i,i) }

# eliminate samples marked as "X"
sel <- which(sml != "X")
sml <- sml[sel]
gset_reduced <- gset[ ,sel]

# log2 transform
ex <- exprs(gset_reduced)
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
LogC <- (qx[5] > 100) ||
          (qx[6]-qx[1] > 50 && qx[2] > 0) ||
          (qx[2] > 0 && qx[2] < 1 && qx[4] > 1 && qx[4] < 2)
if (LogC) { ex[which(ex <= 0)] <- NaN
  exprs(gset_reduced) <- log2(ex) }
```

```{r limmafit}
# set up the data and proceed with analysis
sml <- paste("G", sml, sep="")    # set group names
fl <- as.factor(sml)
gset_reduced$description <- fl
design <- model.matrix(~ description + 0, gset_reduced) # perhaps we can 
colnames(design) <- levels(fl)
fit <- lmFit(gset_reduced, design)
cont.matrix <- makeContrasts(G1-G0, levels=design)
# fit1 <- contrasts.fit(fit,cont.matrix)
fit2 <- contrasts.fit(fit, cont.matrix)
# fit1 <- eBayes(fit1, 1)
fit2 <- eBayes(fit2, 0.01)
tT <- topTable(fit2, adjust="fdr", sort.by="B", number=250)
# allT <- topTable(fit2, adjust="none", sort.by="B",number = nrow(fit2))
tT <- topTable(fit2, adjust="fdr", sort.by="B",number = nrow(fit2))

allT_subset <- subset(allT, select=c("ID","adj.P.Val","P.Value","t","B","logFC","GENE_SYMBOL","GENE_NAME"))
tT_subset <- subset(tT, select=c("ID","adj.P.Val","P.Value","t","B","logFC","GENE_SYMBOL","GENE_NAME"))
```

Volcano plot of the results
```{r volc_plot}
alpha <- 0.01
plot(tT_subset$logFC,
     -log10(tT_subset$adj.P.Val),
     xlab=c("logFC"),
     ylab="adj.P.val",
     pch=20,
     col=as.factor(tT_subset$adj.P.Val <= alpha))
```

```{r boxplot}
################################################################
# #   Boxplot for selected GEO samples
# # library(Biobase)
# # library(GEOquery)
# 
# # load series and platform data from GEO
# 
# gset <- getGEO("GSE57341", GSEMatrix =TRUE, getGPL=FALSE)
# if (length(gset) > 1) idx <- grep("GPL4133", attr(gset, "names")) else idx <- 1
# gset <- gset[[idx]]
# 
# # group names for all samples in a series
# gsms <- paste0("XXXX0000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
#         "XXXXXXXXXXX1111XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
#         "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
#         "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
#         "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX")
# sml <- c()
# for (i in 1:nchar(gsms)) { sml[i] <- substr(gsms,i,i) }
# sml <- paste("G", sml, sep="")  # set group names
# 
# # eliminate samples marked as "X"
# sel <- which(sml != "X")
# sml <- sml[sel]
# gset <- gset[ ,sel]

# order samples by group
ex <- exprs(gset)[ , order(sml)]
sml <- sml[order(sml)]
fl <- as.factor(sml)
labels <- c("ZR-75-1","ZR-75-30")

# set parameters and draw the plot
palette(c("#dfeaf4","#f4dfdf", "#AABBCC"))
dev.new(width=4+dim(gset)[[2]]/5, height=6)
par(mar=c(2+round(max(nchar(sampleNames(gset)))/2),4,2,1))
title <- paste ("GSE57341", '/', annotation(gset), " selected samples", sep ='')
boxplot(ex, boxwex=0.6, notch=T, main=title, outline=FALSE, las=2, col=fl)
legend("topleft", labels, fill=palette(), bty="n")

```


## Goals of this analysis 

I would like to...

1. Compare the Aza-treated cell lines with non-treated cell lines across the . Specifically, find the genes that are not differentially expressed amongst the Aza-treated cell lines but are all differentially expressed with respect to their untreated counterparts. Keep the "up" and "down" genes separately
2. For each cell line studied, find the genes that go up 
3. Determine whether this signature is enriched for immune genes (use GSVA for this purpose)

