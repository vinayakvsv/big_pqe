---
title: "TIMER analysis"
output: html_notebook
---

This notebook implements TIMER to analyze immune infiltrate composition within TCGA samples. TIMER has a web portal that could give us the results for each of the desired tumor types (Ovarian, Breast, Colon, and Lung), but we are going to manually re-run the analysis so that we can compare the expression of the three papers' human IFN-viral signatures to the enrichment of different immune subsets in TCGA samples for the same data. On the other hand, I can download the Cox PH model output from https://cistrome.shinyapps.io/timer/

# Setup

We will locate the TIMER script (we won't source it, because doing so runs the script right away), format the data as the tutorial asks (tutorial is here: http://cistrome.org/TIMER/misc/readme.txt)

The preparation required
```
TIMER analaysis was all performed on the Cancer Genome Atlas (TCGA) samples. The gene expression data profiled by RNA-seq or Affymetrix arrays are accessible through GDAC firehose (https://gdac.broadinstitute.org). Please first download all the data matrices (preferrably RSEM, if not available, then RPKM) and transform them into XXXX.Rdata format (where XXXX is the cancer abbreviation, in lower case, same below), then deposit into a folder named "RNAseq". Clinical data for all cancers should be downloaded from TCGA public ftp: https://tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/anonymous/tumor/XXXX/bcr/nationwidechildrens.org/bio/clin/. Replace "XXXX" with the desired cancer abbreviation and select the latest version of the clinical file ending with "patient_XXXX.txt". Please put all the clinical data files into a folder named "Clinical". TIMER requires tumor purity information for acurate estimation of immune-related genes. Purity is available in the Related data files. After downloading the zip file, please unzip the purity estimation files into a folder named "AGP". TIMER also uses reference immune cell expression files to estimate the immune infiltration levels. These files are available in the Related data files 1-3. Please download these files and put them into a folder named "immune_datasets". Please also download the Supplementar Table S5 from Rooney et al., 2015, Cell and convert it to a text file (mmc5.txt) and place it into a folder named "virus". 
```
## packages

```{r}
# TIMER analysis requires a number of R packages, including: ggplot2, ppcor, reshape2, survival, qvalue and CHAT. Make sure you have installed these packages before running the R codes.
library(ggplot2)
library(reshape2)
library(survival)
install.packages("ppcor")
library(ppcor)
# dependencies for CHAT
biocLite("DNAcopy")
install.packages("DPpackage")
library(DNAcopy)
library(DPpackage)
# CHAT was removed from the CRAN network, so an archived .tar.gz file from https://cran.r-project.org/src/contrib/Archive/CHAT/ (v1.1) was installed instead. 
# Go to the folder to which you downloaded CHAT and type in "R CMD INSTALL CHAT_1.1.tar.gz"
library(CHAT)
# source("https://bioconductor.org/biocLite.R")
biocLite("qvalue")
library(qvalue)
```

## GDAC data

```{r}
# Please first download all the data matrices (preferrably RSEM, if not available, then RPKM) and transform them into XXXX.Rdata format (where XXXX is the cancer abbreviation, in lower case, same below), then deposit into a folder named "RNAseq".
# downloaded GDAC files; now to load them

# Breast
brca_gdac <- read.table(file = "../../datasets/gdac_firehose/gdac.broadinstitute.org_BRCA.Merge_rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level_3.2016012800.0.0/BRCA.rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.data.txt",header = TRUE,sep = "\t",row.names = 1)
save(brca_gdac, file = "./RNAseq/brca.RData")

# Colon
coad_gdac <- read.table(file = "../../datasets/gdac_firehose/gdac.broadinstitute.org_COAD.Merge_rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level_3.2016012800.0.0/COAD.rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.data.txt",header = TRUE,sep = "\t",row.names = 1)
save(brca_gdac, file = "./RNAseq/coad.RData")

# Lung
lusc_gdac <- read.table(file = "../../datasets/gdac_firehose/gdac.broadinstitute.org_LUSC.Merge_rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level_3.2016012800.0.0/LUSC.rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.data.txt",header = TRUE,sep = "\t",row.names = 1)
save(brca_gdac, file = "./RNAseq/lusc.RData")

# Ovarian
ov_gdac <- read.table(file = "../../datasets/gdac_firehose/gdac.broadinstitute.org_OV.Merge_rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level_3.2016012800.0.0/OV.rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.data.txt",header = TRUE,sep = "\t",row.names = 1)
save(brca_gdac, file = "./RNAseq/ov.RData")

```


## Clinical data

```{r}
# Clinical data for all cancers should be downloaded from TCGA public ftp: https://tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/anonymous/tumor/XXXX/bcr/nationwidechildrens.org/bio/clin/. Replace "XXXX" with the desired cancer abbreviation and select the latest version of the clinical file ending with "patient_XXXX.txt". Please put all the clinical data files into a folder named "Clinical". 
```

## Purity information

```{r}
# TIMER requires tumor purity information for acurate estimation of immune-related genes. Purity is available in the Related data files. After downloading the zip file, please unzip the purity estimation files into a folder named "AGP".
```


## Immune signatures

```{r}
# TIMER also uses reference immune cell expression files to estimate the immune infiltration levels. These files are available in the Related data files 1-3. Please download these files and put them into a folder named "immune_datasets". 
# Please also download the Supplementar Table S5 from Rooney et al., 2015, Cell and convert it to a text file (mmc5.txt) and place it into a folder named "virus". 
```




