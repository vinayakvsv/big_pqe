---
title: "Signature extraction from Canadas et al 2018"
output: html_notebook
---

# Import data

```{r}
# Version info: R 3.2.3, Biobase 2.30.0, GEOquery 2.40.0, limma 3.26.8
# R scripts generated  Fri Aug 31 00:53:50 EDT 2018


# Server: www.ncbi.nlm.nih.gov
# Query: acc=GSE45120&platform=GPL6244&type=txt&groups=ZR-75-1|ZR-75-30&colors=dfeaf4|f4dfdf&selection=XXXXXX&padj=fdr&logtransform=auto&columns=ID&columns=adj.P.Val&columns=P.Value&columns=t&columns=B&columns=logFC&columns=Gene+symbol&columns=Gene+title&num=250&annot=ncbi

# Unable to generate script analyzing differential expression.
#      Invalid input: at least two groups of samples should be selected.

################################################################
#   Boxplot for selected GEO samples
library(Biobase)
library(GEOquery)

# load series and platform data from GEO

canadas_data <- paste(getwd(),"../..","datasets","canadas_2018/",sep = "/")
gset_canadas0 <- getGEO("GSE45120",destdir = canadas_data)
if (length(gset_canadas0) > 1) idx <- grep("GPL6244", attr(gset, "names")) else idx <- 1
gset_canadas <- gset_canadas0[[idx]]

# # set parameters and draw the plot
# palette(c("#dfeaf4","#f4dfdf", "#AABBCC"))
# dev.new(width=4+dim(gset)[[2]]/5, height=6)
# par(mar=c(2+round(max(nchar(sampleNames(gset)))/2),4,2,1))
# title <- paste ("GSE45120", '/', annotation(gset), " selected samples", sep ='')
# boxplot(exprs(gset), boxwex=0.7, notch=T, main=title, outline=FALSE, las=2)

```

## log2 transform
```{r}
# log2 transform
exfull <- exprs(gset_canadas)
# remove NAs
gset_canadas_trsf <- gset_canadas
qxfull <- as.numeric(quantile(exfull, c(0., 0.25, 0.5, 0.75, 0.99,1.0), na.rm=T))
LogCfill <- (qxfull[5] > 100) ||
          (qxfull[6]-qxfull[1] > 50 && qxfull[2] > 0) ||
          (qxfull[2] > 0 && qxfull[2] < 1 && qxfull[4] > 1 && qxfull[4] < 2)
# invoke this if log2 normalization isn't already in effect
if (LogCfill) { 
  print("log normalizing")
  exfull[which(exfull <= 0)] <- NaN
  exprs(gset_canadas_trsf) <- log2(exfull) 
  } else if (qxfull[6] > 100) {
  # if the qxfull[6] full is extremely high...
    print("adjusting values")
    # remove extremely high values; since these are log2 fold changes, we don't want anything insanely high
    exfull[which(exfull >= 10)] <- NA
    # also remove extremely low values
    exfull[which(exfull < -10)] <- NA
    exprs(gset_canadas_trsf) <- exfull
}

# remove all rows that are all NA's
gset_canadas_trsf_with_NA <- apply(X = gset_canadas_trsf,
                           MARGIN = 1,
                           function(x) {
                             #length(x[is.na(x)]) > 1
                             length(x[is.na(x)]) == length(x)
                             })
gset_canadas_trsf_with_NA <- gset_canadas_trsf_with_NA[gset_canadas_trsf_with_NA]

```

# Differential expression analysis 

The data came from a one-channel microarray

```{r print_description}
print(gset_canadas$description)
```

## Set design 
This is a pretty simple experimental setup: two conditions, one H69M and one H69 (both cell lines). We should consider how lung-cancer inflammation responses vary from EOC, Breast, or Colon cancer responses (as in Li et al 2014 and Chiappinelli et al 2015)

```{r set_design}
gset_canadas_meta <- data.frame(celltype=gset_canadas$`cell line:ch1`)
gset_canadas_trsf$description <- gset_canadas_meta$celltype
design_canadas <- model.matrix(~ 0 + description, gset_canadas_trsf)
colnames(design_canadas) <- levels(gset_canadas_meta$celltype)
```

## Model fit

We will now fit the model. This doesn't appear to be log2-normalized, so we will do so here
```{r}
exprs(gset_canadas_trsf) <- log2(exfull)
lmfit_canadas <- lmFit(gset_canadas_trsf, design_canadas)
```

Extract necessary statistics
```{r extract_stats}
alpha <- 0.05
log2fc_lim <- 0.5
canadas_cont_matrix <- makeContrasts(H69M-H69, levels=design_canadas)
lmfit_canadas_fit1 <- contrasts.fit(lmfit_canadas, canadas_cont_matrix)
lmfit_canadas_ebayes <- eBayes(fit = lmfit_canadas_fit1,proportion = alpha)
tT_canadas <- topTable(lmfit_canadas_ebayes, 
                       adjust="fdr", 
                       sort.by="B", number=nrow(gset_canadas_trsf))

# now for the frustrating business of extracting the names of different genes
tT_canadas_gene_names <- sapply(tT_canadas$gene_assignment,
                                function(x) {
                                  a <- unlist(strsplit(x = as.character(x),split = " // ",fixed = TRUE))
                                  a[2]
                                })
tT_canadas$GENE_SYMBOL <- as.character(tT_canadas_gene_names)

tT_canadas_subset <- subset(tT_canadas, select=c("ID","adj.P.Val","P.Value","t","B","logFC","GENE_SYMBOL","AveExpr"))

# # fit1 <- contrasts.fit(fit,cont.matrix)
# fit2 <- contrasts.fit(fit_bycell, cont.matrix)
# # fit1 <- eBayes(fit1, 1)
# fit2 <- eBayes(fit2, 0.01)
# tT <- topTable(fit2, adjust="fdr", sort.by="B", number=250)
# # allT <- topTable(fit2, adjust="none", sort.by="B",number = nrow(fit2))
# tT <- topTable(fit2, adjust="fdr", sort.by="B",number = nrow(fit2))

```

Volcano plot of the results
```{r volc_plot}
plot(tT_canadas_subset$logFC,
     -log10(tT_canadas_subset$adj.P.Val),
     xlab=c("log2FC (H69M-H69)"),
     ylab="adj.P.val",
     pch=20,
     col=as.factor(tT_canadas_subset$adj.P.Val <= alpha & tT_canadas_subset$logFC >= log2fc_lim))
abline(h = -log10(alpha),
       v = log2fc_lim,
       lty=2,
       col="red")

tT_canadas_sig <- subset(tT_canadas_subset,adj.P.Val <= alpha & logFC >= log2fc_lim)
# IFNB has a fold-change in expression of 0.2
```
